---
eip: 7776
title: Use Gross rather than Net for Block Gas Accounting
description: Exclude Discounts & Refunds for Block GasLimit Enforcement
author: Ben Adams (@benaadams)
discussions-to: https://ethereum-magicians.org/t/eip-7773-amsterdam-network-upgrade-meta-thread/21195
status: Draft
type: Standards Track
category: Core
created: 2024-10-01
---

## **Summary**

Alternative to [EIP-7623](./eip-7623): "Increase Calldata Cost".

Instead adjust the Ethereum Virtual Machine (EVM) gas accounting mechanism so that gas discounts and refunds are excluded from block gas limit calculations, except for discounts that correspond to actual reductions in computational work.

Users still receive gas discounts and refunds for certain operations, but these do not allow blocks to include more transaction gas than the block gas limit permits, except where the EVM's workload is genuinely reduced.

## **Abstract**

This proposal modifies the gas accounting for blocks by excluding discounts and refunds from block gas limit calculations, except for those associated with actual reductions in EVM workload, such as:

- Warm vs. cold storage access costs.
- `SSTORE` operations that revert a storage slot to its original value (in same tx).

User-facing gas costs and refunds remain unchanged, preserving incentives for efficient behavior. This ensures that the block gas usage accurately reflects the EVM's computational and storage workload, preventing blocks from exceeding the block gas limit due to discounted operations.

## **Motivation**

### **Addressing the Rationale in EIP-7623**

[EIP-7623](./eip-7623) proposes increasing calldata costs to reduce the maximum possible block size and its variance, without impacting regular users. The rationale is to:

- **Reduce Maximum Block Size:** Prevent excessively large blocks that can burden the network.
- **Make Room for Blobs:** Accommodate new data availability solutions like blobs introduced in EIP-4844.
- **Reduce Block Size Variance:** Enhance network predictability and efficiency.

**This proposal addresses the same rationale but through a different approach:**

- **Preventing Block Gas Limit Circumvention:** By excluding discounts and refunds from block gas accounting, we prevent transactions from effectively "smuggling" extra gas usage into blocks via discounted operations.
- **Maintaining User Costs:** Users still pay the same gas costs and receive the same refunds, ensuring regular users are not adversely affected.
- **Aligning Actual Workload with Block Gas Limit:** Ensures that the block gas limit accurately represents the computational and storage workload, reducing the maximum block size and its variance naturally.

**Advantages over EIP-7623:**

- **No Increase in User Costs:** Unlike increasing calldata costs for certain transactions, this proposal does not raise gas prices for users.
- **Simplifies Gas Accounting:** By adjusting block gas accounting rather than individual operation costs, it maintains existing gas cost structures for users.
- **Encourages Efficient Usage:** Preserves incentives for users to engage in efficient behaviors (e.g., clearing storage, optimizing calldata), without enabling them to exceed block limits.
- **Deterministically Caps Calldata** Call data will be always capped at the lower end because there is no discount in the block accounting; which uses the gross price, rather than net price after the zero discount is applied.

### **Current Issues with Gas Discounts and Refunds**

- **Calldata Discounts:** Inclusion of large amounts of zero-filled calldata due to lower gas costs for zero bytes can lead to blocks that impose a higher workload than intended.
- **`SSTORE` Refunds:** Gas refunds from resetting storage slots can be used to offset gas costs, allowing more operations within a block than the gas limit would suggest.
- **Block Gas Limit Circumvention:** Net gas usage after discounts and refunds can be misleading, permitting blocks to include more computational work than the block gas limit intends.

## **Specification**

| Parameter | Value |
| - | - |
| `STANDARD_TOKEN_COST`    |  `16` |
| `ZERO_TOKEN_DISCOUNT`    |  `12` |
| `ZERO_TOKEN_COST`    |  `STANDARD_TOKEN_COST` - `ZERO_TOKEN_DISCOUNT` |

For calldata user tx price the gas used remains the same

```
tx.gasused = (
    21000 \ 
        + STANDARD_TOKEN_COST * non_zero_tokens_in_calldata \
        + ZERO_TOKEN_COST * zero_tokens_in_calldata \
        + evm_gas_used \
        + isContractCreation * (32000 + InitCodeWordGas * words(calldata))
)
```
However for block gas used, zero tokens are priced as non-zero tokens
```
block.gasused = Sum(
    21000 \ 
        + (non_zero_tokens_in_calldata + zero_tokens_in_calldata) \
            + STANDARD_TOKEN_COST \
        + evm_gas_used \
        + isContractCreation * (32000 + InitCodeWordGas * words(calldata))
)
```

For refunds user tx price the gas used remains the same

```
tx.evm_gas_used = evm_gas_used - evm_gas_refund
```
However for block gas used, the refund is not considered
```
block.evm_gas_used = evm_gas_used
```

### **Gas Accounting Changes**

1. **User Gas Costs:**

   - **Calldata Gas Cost:**
     - Users continue to pay 4 gas per zero byte and 16 gas per non-zero byte in calldata.
   - **`SSTORE` Operations:**
     - Users continue to receive gas refunds as per the current mechanism when resetting storage slots to zero or reverting them to their original values.
   - **Warm vs. Cold Storage Access Costs:**
     - Users continue to benefit from lower gas costs for warm storage accesses compared to cold storage accesses.

2. **Block Gas Accounting:**

   - **Calldata:**
     - For block gas limit calculations, all calldata bytes are charged at 16 gas per byte, regardless of whether they are zero or non-zero bytes.
   - **`SSTORE` Operations:**
     - **Setting Storage to Zero:**
       - For block gas accounting, `SSTORE` operations that set storage to zero are charged at their full cost without subtracting refunds.
     - **Reverting Storage to Original Value:**
       - For block gas accounting, `SSTORE` operations that revert a storage slot to its original value in the same transaction receive the same gas discount as in user gas costs, reflecting the reduced workload (no actual write to storage).
   - **Warm vs. Cold Storage Access:**
     - Discounts for warm storage accesses are preserved in block gas accounting, as they correspond to reduced computational effort.
   - **Other Discounts and Refunds:**
     - Any other gas discounts or refunds not associated with actual reductions in computational workload are excluded from block gas accounting.

### **Block Gas Limit Enforcement**

- **Block Gas Usage:**
  - The sum of the gas used by all transactions in a block, calculated using the adjusted block gas accounting rules above, must not exceed the block gas limit.

### **Transaction Gas Usage**

- **Transaction Gas Limit:**
  - Transactions must specify a gas limit that covers their total gas usage after discounts and refunds.
  - Users continue to receive discounts and refunds at the transaction level as per existing rules.

## **Rationale**

### **Resolving the Rationale in EIP-7623**

By adjusting block gas accounting rather than increasing calldata costs:

- **Reduces Maximum Block Size:**
  - Prevents blocks from including excessive operations through discounted gas costs, effectively reducing the maximum possible block size.
- **Reduces Block Size Variance:**
  - Ensures that block gas usage reflects actual computational and storage work, leading to more consistent block sizes.
- **Accommodates New Data Availability Solutions:**
  - By not increasing calldata costs, this proposal does not discourage the use of calldata for data availability by rollups and other Layer 2 solutions.
  - Makes room for incorporating blobs or other data availability methods without overburdening the network.

### **Aligning Workload with Block Gas Limit**

- Excluding non-workload-related discounts from block gas accounting ensures that the block gas limit accurately represents the EVM's actual workload.
- Prevents the network from processing more transactions or operations than intended, enhancing stability and security.

### **Preserving User Incentives**

- Users continue to benefit from gas discounts and refunds that correspond to actual reductions in computational effort.
- Encourages efficient behaviors, such as:

  - **Efficient Storage Usage:**
    - Incentivizes returning storage slots to their original values when possible.
  - **Optimized Contract Design:**
    - Encourages designs that minimize unnecessary writes and leverage warm storage accesses.

### **Calldata Considerations**

- Charging full gas cost for calldata in block gas accounting prevents oversized calldata from exceeding block gas limits due to discounts on zero bytes.
- Users still pay lower costs for zero bytes, preserving incentives to optimize calldata size.

### **`SSTORE` Operations**

- **Setting to Zero:**
  - Excluding refunds from block gas accounting for resetting storage to zero ensures blocks do not include more storage operations than intended.
- **Reverting to Original Value:**
  - Preserving discounts for reverting storage to its original value reflects the reduced workload (no storage write needed), aligning block gas usage with actual effort.

### **Warm vs. Cold Storage Access**

- Preserving warm storage access discounts in block gas accounting accurately represents reduced computational effort.
- Encourages efficient storage access patterns in contracts.

## **Backwards Compatibility**

- **Hard Fork Required:**
  - This change is not backwards compatible and requires a network upgrade (hard fork).
- **Impact on Users and Developers:**
  - Users and smart contract developers are generally unaffected in terms of transaction costs.
  - Infrastructure and tooling that rely on gas calculations may need updates to align with the new block gas accounting rules.

## **Security Considerations**

- **Network Stability:**
  - Ensures the block gas limit accurately represents the EVM's workload, enhancing network stability and predictability.
- **Denial-of-Service (DoS) Risks:**
  - Mitigates potential DoS attack vectors that exploit gas refunds and discounts to exceed intended computational workloads within blocks.

## **Test Cases**

Developers should consider the following test cases:

1. **Calldata Transactions:**

   - A transaction with large zero-filled calldata should consume more block gas but cost the user the same.
   - Verify that such a transaction cannot be included if it would cause the block gas usage to exceed the limit.

2. **`SSTORE` Reset to Zero:**

   - A transaction resetting storage slots to zero provides refunds to the user but consumes full gas in block accounting.
   - Ensure inclusion of such transactions adheres to the adjusted block gas limit.

3. **`SSTORE` Reverting to Original Value:**

   - A transaction that sets a storage slot back to its original value benefits from gas discounts in both user gas costs and block gas accounting.
   - Verify that block gas usage reflects the reduced cost due to no net storage change.

4. **Warm vs. Cold Storage Accesses:**

   - Transactions with multiple accesses to the same storage slot benefit from warm storage discounts in both user gas costs and block gas accounting.
   - Ensure block gas usage accurately reflects these discounts.

5. **Blocks Near Gas Limit:**

   - Construct blocks reaching the block gas limit under the new accounting rules to ensure correct processing without exceeding the limit.

## **Implementation**

Implementers need to adjust the gas accounting mechanism in their Ethereum clients:

- **Transaction Execution:**

  - Modify gas accounting to separate user gas costs from block gas usage, applying the adjusted rules.
  - Ensure discounts for operations that reduce workload (warm accesses, `SSTORE` reverting to original value) are included in block gas accounting.

- **Block Validation:**

  - Update block validation logic to enforce the adjusted block gas limit based on gross gas usage, considering discounts only for operations that reflect actual reductions in computational effort.

## **References**

- [EIP-7623](./eip-7623): Increase Calldata Cost
- [EIP-2200](./eip-2200): Structured Definitions for `SSTORE` Net Gas Metering
- [EIP-2929](./eip-2929): Gas Cost Increases for State Access Opcodes
- [EIP-3529](./eip-3529): Reduction in Refunds
- [EIP-1559](./eip-1559): Fee Market Change for ETH 1.0 Chain

## **Copyright**

Copyright and related rights waived via CC0 1.0 Universal.
